/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
import { DataSource } from '@angular/cdk/collections';
import { EventEmitter } from '@angular/core';
import { mergeQueryParams, } from '@gngt/core/common';
import { BehaviorSubject, combineLatest, of as obsOf, Subscription } from 'rxjs';
import { debounceTime, map, startWith, switchMap, tap } from 'rxjs/operators';
export class ModelDataSource extends DataSource {
    constructor(_service, _baseParams = {}) {
        super();
        this._service = _service;
        this._baseParams = _baseParams;
        this._sort = null;
        this._filter = new BehaviorSubject('');
        this._baseQueryParams = new BehaviorSubject(null);
        this._freeTextSearchFields = new BehaviorSubject([]);
        this._filters = new BehaviorSubject({});
        this._paginator = null;
        this._data = new BehaviorSubject([]);
        this._sortParams = new BehaviorSubject(null);
        this._sortSubscription = Subscription.EMPTY;
        this._paginatorParams = new BehaviorSubject(null);
        this._paginatorSubscription = Subscription.EMPTY;
        this._dataSubscription = Subscription.EMPTY;
        this._refreshEvent = new EventEmitter();
    }
    get sort() {
        return this._sort;
    }
    set sort(sort) {
        this._sort = sort;
        this._updateSort();
    }
    get filter() {
        return this._filter.value;
    }
    set filter(filter) {
        this._filter.next(filter);
    }
    get baseQueryParams() {
        return this._baseQueryParams.value;
    }
    set baseQueryParams(params) {
        this._baseQueryParams.next(params);
    }
    get freeTextSearchFields() {
        return this._freeTextSearchFields.value;
    }
    set freeTextSearchFields(freeTextSearchFields) {
        this._freeTextSearchFields.next([...freeTextSearchFields]);
    }
    get filters() {
        return this._filters.value;
    }
    set filters(filters) {
        this._filters.next(filters);
    }
    get paginator() {
        return this._paginator;
    }
    set paginator(paginator) {
        this._paginator = paginator;
        this._updatePaginator();
    }
    get data() {
        return this._data.value;
    }
    set dataModifier(dataModifier) {
        this._dataModifier = dataModifier;
    }
    connect(_) {
        this._initData();
        return this._data;
    }
    disconnect(_) {
        this._dataSubscription.unsubscribe();
        this._sortSubscription.unsubscribe();
        this._paginatorSubscription.unsubscribe();
        this._sortParams.complete();
        this._paginatorParams.complete();
        this._filters.complete();
    }
    refresh() {
        this._refreshEvent.next();
    }
    _initData() {
        const baseStream = combineLatest(this._paginatorParams, this._sortParams, this._filter, this._freeTextSearchFields, this._filters, this._refreshEvent, this._baseQueryParams);
        const startValue = [null, null, '', [], {}, undefined, null];
        this._dataSubscription =
            baseStream
                .pipe(startWith(startValue), debounceTime(10), switchMap(p => {
                const pagination = p[0];
                const sort = p[1];
                const filter = p[2];
                const freeTextSearchFields = p[3];
                const filters = p[4];
                const freeTextSel = {};
                const filterWord = (filter || '').trim();
                const baseParams = p[6];
                if (filter != null && freeTextSearchFields != null && filterWord.length > 0 &&
                    freeTextSearchFields.length > 0) {
                    freeTextSel['$or'] = freeTextSearchFields.map(key => {
                        const keySel = {};
                        keySel[key] = { '$regex': filterWord };
                        return keySel;
                    });
                }
                const params = Object.assign(Object.assign({}, this._baseParams), { selector: Object.assign(Object.assign({}, filters), freeTextSel) });
                if (pagination != null) {
                    const pag = pagination;
                    params.limit = pag.pageSize;
                    params.start = pag.pageIndex * pag.pageSize;
                }
                if (sort != null) {
                    const so = sort;
                    const direction = so.direction === '' ? 'asc' : so.direction;
                    params.sort = { [so.active]: direction };
                }
                return this._service.query(mergeQueryParams(params, baseParams || {}));
            }), tap(o => {
                const list = o;
                const paginator = this.paginator;
                if (paginator != null) {
                    paginator.length = list && list.count ? list.count : 0;
                }
            }), map(o => {
                const list = o;
                return list && list.results ? list.results : [];
            }), switchMap(data => {
                if (this._dataModifier != null) {
                    return this._dataModifier(data);
                }
                return obsOf(data);
            }))
                .subscribe(data => {
                this._data.next(data);
            });
        this._refreshEvent.next();
    }
    _updateSort() {
        this._sortSubscription.unsubscribe();
        this._sortSubscription =
            this._sort != null ? this._sort.sortChange.subscribe(this._sortParams) : Subscription.EMPTY;
    }
    _updatePaginator() {
        this._paginatorSubscription.unsubscribe();
        this._paginatorSubscription = this._paginator != null ?
            this._paginator.page.subscribe(this._paginatorParams) :
            Subscription.EMPTY;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwtZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWF0ZXJpYWwvbW9kZWwvbW9kZWwtZGF0YS1zb3VyY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FtQkc7QUFFSCxPQUFPLEVBQW1CLFVBQVUsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQ3RFLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUNMLGdCQUFnQixHQUtqQixNQUFNLG1CQUFtQixDQUFDO0FBRTNCLE9BQU8sRUFBQyxlQUFlLEVBQUUsYUFBYSxFQUFjLEVBQUUsSUFBSSxLQUFLLEVBQUUsWUFBWSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzNGLE9BQU8sRUFBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFTNUUsTUFBTSxPQUFPLGVBRThFLFNBQ3ZGLFVBQWE7SUFDZixZQUFvQixRQUFZLEVBQVUsY0FBK0IsRUFBRTtRQUN6RSxLQUFLLEVBQUUsQ0FBQztRQURVLGFBQVEsR0FBUixRQUFRLENBQUk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBc0I7UUFXbkUsVUFBSyxHQUFpQixJQUFJLENBQUM7UUFRM0IsWUFBTyxHQUE0QixJQUFJLGVBQWUsQ0FBUyxFQUFFLENBQUMsQ0FBQztRQVFuRSxxQkFBZ0IsR0FBRyxJQUFJLGVBQWUsQ0FBaUMsSUFBSSxDQUFDLENBQUM7UUFFN0UsMEJBQXFCLEdBQThCLElBQUksZUFBZSxDQUFXLEVBQUUsQ0FBQyxDQUFDO1FBY3JGLGFBQVEsR0FDWixJQUFJLGVBQWUsQ0FBeUIsRUFBRSxDQUFDLENBQUM7UUFTNUMsZUFBVSxHQUFzQixJQUFJLENBQUM7UUFFckMsVUFBSyxHQUF5QixJQUFJLGVBQWUsQ0FBTSxFQUFFLENB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QVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO0lBQ2xHLENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELFlBQVksQ0FBQyxLQUFLLENBQUM7SUFDekIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChDKSBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgR251Y29vcCBBbmd1bGFyIFRvb2xraXQgKGduZ3QpLlxuICpcbiAqIEdudWNvb3AgQW5ndWxhciBUb29sa2l0IChnbmd0KSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogR251Y29vcCBBbmd1bGFyIFRvb2xraXQgKGduZ3QpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBHbnVjb29wIEFuZ3VsYXIgVG9vbGtpdCAoZ25ndCkuICBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0NvbGxlY3Rpb25WaWV3ZXIsIERhdGFTb3VyY2V9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2xsZWN0aW9ucyc7XG5pbXBvcnQge0V2ZW50RW1pdHRlcn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge01hdFBhZ2luYXRvciwgUGFnZUV2ZW50fSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9wYWdpbmF0b3InO1xuaW1wb3J0IHtNYXRTb3J0LCBTb3J0fSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9zb3J0JztcbmltcG9ydCB7XG4gIG1lcmdlUXVlcnlQYXJhbXMsXG4gIE1vZGVsLFxuICBNb2RlbExpc3RQYXJhbXMsXG4gIE1vZGVsTGlzdFJlc3VsdCxcbiAgTW9kZWxRdWVyeVBhcmFtcyxcbn0gZnJvbSAnQGduZ3QvY29yZS9jb21tb24nO1xuaW1wb3J0IHtNb2RlbEFjdGlvblR5cGVzLCBNb2RlbFNlcnZpY2UsIFN0YXRlIGFzIE1vZGVsU3RhdGV9IGZyb20gJ0Bnbmd0L2NvcmUvbW9kZWwnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIG9mIGFzIG9ic09mLCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtkZWJvdW5jZVRpbWUsIG1hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge01vZGVsRGF0YVNvdXJjZUZpbHRlcnN9IGZyb20gJy4vbW9kZWwtZGF0YS1zb3VyY2UtZmlsdGVycyc7XG5cbnR5cGUgRGF0YVN0cmVhbVR5cGUgPSBbXG4gIFBhZ2VFdmVudCB8IG51bGwsIFNvcnQgfCBudWxsLCBzdHJpbmcsIHN0cmluZ1tdLCBNb2RlbERhdGFTb3VyY2VGaWx0ZXJzLCB2b2lkLFxuICBQYXJ0aWFsPE1vZGVsUXVlcnlQYXJhbXM+fCBudWxsXG5dO1xuXG5leHBvcnQgY2xhc3MgTW9kZWxEYXRhU291cmNlPFQgZXh0ZW5kcyBNb2RlbCwgUyBleHRlbmRzIE1vZGVsU3RhdGU8VD4gPSBNb2RlbFN0YXRlPFQ+LCBBIGV4dGVuZHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQWN0aW9uVHlwZXMgPSBNb2RlbEFjdGlvblR5cGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTVMgZXh0ZW5kcyBNb2RlbFNlcnZpY2U8VCwgUywgQT4gPSBNb2RlbFNlcnZpY2U8VCwgUywgQT4+IGV4dGVuZHNcbiAgICBEYXRhU291cmNlPFQ+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfc2VydmljZTogTVMsIHByaXZhdGUgX2Jhc2VQYXJhbXM6IE1vZGVsTGlzdFBhcmFtcyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGdldCBzb3J0KCk6IE1hdFNvcnR8bnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuX3NvcnQ7XG4gIH1cbiAgc2V0IHNvcnQoc29ydDogTWF0U29ydHxudWxsKSB7XG4gICAgdGhpcy5fc29ydCA9IHNvcnQ7XG4gICAgdGhpcy5fdXBkYXRlU29ydCgpO1xuICB9XG4gIHByaXZhdGUgX3NvcnQ6IE1hdFNvcnR8bnVsbCA9IG51bGw7XG5cbiAgZ2V0IGZpbHRlcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXIudmFsdWU7XG4gIH1cbiAgc2V0IGZpbHRlcihmaWx0ZXI6IHN0cmluZykge1xuICAgIHRoaXMuX2ZpbHRlci5uZXh0KGZpbHRlcik7XG4gIH1cbiAgcHJpdmF0ZSBfZmlsdGVyOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPignJyk7XG5cbiAgZ2V0IGJhc2VRdWVyeVBhcmFtcygpOiBQYXJ0aWFsPE1vZGVsUXVlcnlQYXJhbXM+fG51bGwge1xuICAgIHJldHVybiB0aGlzLl9iYXNlUXVlcnlQYXJhbXMudmFsdWU7XG4gIH1cbiAgc2V0IGJhc2VRdWVyeVBhcmFtcyhwYXJhbXM6IFBhcnRpYWw8TW9kZWxRdWVyeVBhcmFtc3xudWxsPikge1xuICAgIHRoaXMuX2Jhc2VRdWVyeVBhcmFtcy5uZXh0KHBhcmFtcyk7XG4gIH1cbiAgcHJpdmF0ZSBfYmFzZVF1ZXJ5UGFyYW1zID0gbmV3IEJlaGF2aW9yU3ViamVjdDxQYXJ0aWFsPE1vZGVsUXVlcnlQYXJhbXM+fG51bGw+KG51bGwpO1xuXG4gIHByaXZhdGUgX2ZyZWVUZXh0U2VhcmNoRmllbGRzOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmdbXT4oW10pO1xuICBnZXQgZnJlZVRleHRTZWFyY2hGaWVsZHMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLl9mcmVlVGV4dFNlYXJjaEZpZWxkcy52YWx1ZTtcbiAgfVxuICBzZXQgZnJlZVRleHRTZWFyY2hGaWVsZHMoZnJlZVRleHRTZWFyY2hGaWVsZHM6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5fZnJlZVRleHRTZWFyY2hGaWVsZHMubmV4dChbLi4uZnJlZVRleHRTZWFyY2hGaWVsZHNdKTtcbiAgfVxuXG4gIGdldCBmaWx0ZXJzKCk6IE1vZGVsRGF0YVNvdXJjZUZpbHRlcnMge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJzLnZhbHVlO1xuICB9XG4gIHNldCBmaWx0ZXJzKGZpbHRlcnM6IE1vZGVsRGF0YVNvdXJjZUZpbHRlcnMpIHtcbiAgICB0aGlzLl9maWx0ZXJzLm5leHQoZmlsdGVycyk7XG4gIH1cbiAgcHJpdmF0ZSBfZmlsdGVyczogQmVoYXZpb3JTdWJqZWN0PE1vZGVsRGF0YVNvdXJjZUZpbHRlcnM+ID1cbiAgICAgIG5ldyBCZWhhdmlvclN1YmplY3Q8TW9kZWxEYXRhU291cmNlRmlsdGVycz4oe30pO1xuXG4gIGdldCBwYWdpbmF0b3IoKTogTWF0UGFnaW5hdG9yfG51bGwge1xuICAgIHJldHVybiB0aGlzLl9wYWdpbmF0b3I7XG4gIH1cbiAgc2V0IHBhZ2luYXRvcihwYWdpbmF0b3I6IE1hdFBhZ2luYXRvcnxudWxsKSB7XG4gICAgdGhpcy5fcGFnaW5hdG9yID0gcGFnaW5hdG9yO1xuICAgIHRoaXMuX3VwZGF0ZVBhZ2luYXRvcigpO1xuICB9XG4gIHByaXZhdGUgX3BhZ2luYXRvcjogTWF0UGFnaW5hdG9yfG51bGwgPSBudWxsO1xuXG4gIHByaXZhdGUgX2RhdGE6IEJlaGF2aW9yU3ViamVjdDxUW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUW10+KFtdKTtcbiAgZ2V0IGRhdGEoKTogVFtdIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YS52YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgX2RhdGFNb2RpZmllcjogKGRhdGE6IFRbXSkgPT4gT2JzZXJ2YWJsZTxUW10+O1xuICBzZXQgZGF0YU1vZGlmaWVyKGRhdGFNb2RpZmllcjogKGRhdGE6IFRbXSkgPT4gT2JzZXJ2YWJsZTxUW10+KSB7XG4gICAgdGhpcy5fZGF0YU1vZGlmaWVyID0gZGF0YU1vZGlmaWVyO1xuICB9XG5cbiAgcHJpdmF0ZSBfc29ydFBhcmFtczogQmVoYXZpb3JTdWJqZWN0PFNvcnR8bnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNvcnR8bnVsbD4obnVsbCk7XG4gIHByaXZhdGUgX3NvcnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcbiAgcHJpdmF0ZSBfcGFnaW5hdG9yUGFyYW1zOiBCZWhhdmlvclN1YmplY3Q8UGFnZUV2ZW50fG51bGw+ID1cbiAgICAgIG5ldyBCZWhhdmlvclN1YmplY3Q8UGFnZUV2ZW50fG51bGw+KG51bGwpO1xuICBwcml2YXRlIF9wYWdpbmF0b3JTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcbiAgcHJpdmF0ZSBfZGF0YVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuICBwcml2YXRlIF9yZWZyZXNoRXZlbnQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBjb25uZWN0KF86IENvbGxlY3Rpb25WaWV3ZXIpOiBPYnNlcnZhYmxlPFRbXT4ge1xuICAgIHRoaXMuX2luaXREYXRhKCk7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEgYXMgT2JzZXJ2YWJsZTxUW10+O1xuICB9XG5cbiAgZGlzY29ubmVjdChfOiBDb2xsZWN0aW9uVmlld2VyKTogdm9pZCB7XG4gICAgdGhpcy5fZGF0YVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3NvcnRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLl9wYWdpbmF0b3JTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLl9zb3J0UGFyYW1zLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5fcGFnaW5hdG9yUGFyYW1zLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5fZmlsdGVycy5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcmVmcmVzaCgpOiB2b2lkIHtcbiAgICB0aGlzLl9yZWZyZXNoRXZlbnQubmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaW5pdERhdGEoKTogdm9pZCB7XG4gICAgY29uc3QgYmFzZVN0cmVhbSA9IGNvbWJpbmVMYXRlc3Q8RGF0YVN0cmVhbVR5cGU+KFxuICAgICAgICB0aGlzLl9wYWdpbmF0b3JQYXJhbXMsIHRoaXMuX3NvcnRQYXJhbXMsIHRoaXMuX2ZpbHRlciwgdGhpcy5fZnJlZVRleHRTZWFyY2hGaWVsZHMsXG4gICAgICAgIHRoaXMuX2ZpbHRlcnMsIHRoaXMuX3JlZnJlc2hFdmVudCwgdGhpcy5fYmFzZVF1ZXJ5UGFyYW1zKTtcbiAgICBjb25zdCBzdGFydFZhbHVlID0gW251bGwsIG51bGwsICcnLCBbXSwge30sIHVuZGVmaW5lZCwgbnVsbF0gYXMgRGF0YVN0cmVhbVR5cGU7XG4gICAgdGhpcy5fZGF0YVN1YnNjcmlwdGlvbiA9XG4gICAgICAgIGJhc2VTdHJlYW1cbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHN0YXJ0V2l0aChzdGFydFZhbHVlKSxcbiAgICAgICAgICAgICAgICBkZWJvdW5jZVRpbWUoMTApLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcChwID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHBhZ2luYXRpb24gPSBwWzBdO1xuICAgICAgICAgICAgICAgICAgY29uc3Qgc29ydCA9IHBbMV07XG4gICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBwWzJdO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZnJlZVRleHRTZWFyY2hGaWVsZHMgPSBwWzNdO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVycyA9IHBbNF07XG4gICAgICAgICAgICAgICAgICBjb25zdCBmcmVlVGV4dFNlbDoge1trZXk6IHN0cmluZ106IGFueX0gPSB7fTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcldvcmQgPSAoZmlsdGVyIHx8ICcnKS50cmltKCk7XG4gICAgICAgICAgICAgICAgICBjb25zdCBiYXNlUGFyYW1zID0gcFs2XTtcbiAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXIgIT0gbnVsbCAmJiBmcmVlVGV4dFNlYXJjaEZpZWxkcyAhPSBudWxsICYmIGZpbHRlcldvcmQubGVuZ3RoID4gMCAmJlxuICAgICAgICAgICAgICAgICAgICAgIGZyZWVUZXh0U2VhcmNoRmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZnJlZVRleHRTZWxbJyRvciddID0gZnJlZVRleHRTZWFyY2hGaWVsZHMubWFwKGtleSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5U2VsOiB7W2tleTogc3RyaW5nXTogeyckcmVnZXgnOiBzdHJpbmd9fSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgIGtleVNlbFtrZXldID0geyckcmVnZXgnOiBmaWx0ZXJXb3JkfTtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5U2VsO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtczogTW9kZWxRdWVyeVBhcmFtcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5fYmFzZVBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHtcbiAgICAgICAgICAgICAgICAgICAgICAuLi5maWx0ZXJzLFxuICAgICAgICAgICAgICAgICAgICAgIC4uLmZyZWVUZXh0U2VsLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgaWYgKHBhZ2luYXRpb24gIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwYWcgPSBwYWdpbmF0aW9uIGFzIFBhZ2VFdmVudDtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmxpbWl0ID0gcGFnLnBhZ2VTaXplO1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuc3RhcnQgPSBwYWcucGFnZUluZGV4ICogcGFnLnBhZ2VTaXplO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKHNvcnQgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzbyA9IHNvcnQgYXMgU29ydDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlyZWN0aW9uOiAnYXNjJ3wnZGVzYycgPSBzby5kaXJlY3Rpb24gPT09ICcnID8gJ2FzYycgOiBzby5kaXJlY3Rpb247XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5zb3J0ID0ge1tzby5hY3RpdmVdOiBkaXJlY3Rpb259O1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NlcnZpY2UucXVlcnkobWVyZ2VRdWVyeVBhcmFtcyhwYXJhbXMsIGJhc2VQYXJhbXMgfHwge30pKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICB0YXAobyA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBsaXN0ID0gbyBhcyBNb2RlbExpc3RSZXN1bHQ8VD47XG4gICAgICAgICAgICAgICAgICBjb25zdCBwYWdpbmF0b3IgPSB0aGlzLnBhZ2luYXRvcjtcbiAgICAgICAgICAgICAgICAgIGlmIChwYWdpbmF0b3IgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBwYWdpbmF0b3IubGVuZ3RoID0gbGlzdCAmJiBsaXN0LmNvdW50ID8gbGlzdC5jb3VudCA6IDA7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbWFwKG8gPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgbGlzdCA9IG8gYXMgTW9kZWxMaXN0UmVzdWx0PFQ+O1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpc3QgJiYgbGlzdC5yZXN1bHRzID8gbGlzdC5yZXN1bHRzIDogW107XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2RhdGFNb2RpZmllciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9kYXRhTW9kaWZpZXIoZGF0YSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gb2JzT2YoZGF0YSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZShkYXRhID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5fZGF0YS5uZXh0KGRhdGEgYXMgVFtdKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgdGhpcy5fcmVmcmVzaEV2ZW50Lm5leHQoKTtcbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZVNvcnQoKTogdm9pZCB7XG4gICAgdGhpcy5fc29ydFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3NvcnRTdWJzY3JpcHRpb24gPVxuICAgICAgICB0aGlzLl9zb3J0ICE9IG51bGwgPyB0aGlzLl9zb3J0LnNvcnRDaGFuZ2Uuc3Vic2NyaWJlKHRoaXMuX3NvcnRQYXJhbXMpIDogU3Vic2NyaXB0aW9uLkVNUFRZO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlUGFnaW5hdG9yKCk6IHZvaWQge1xuICAgIHRoaXMuX3BhZ2luYXRvclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3BhZ2luYXRvclN1YnNjcmlwdGlvbiA9IHRoaXMuX3BhZ2luYXRvciAhPSBudWxsID9cbiAgICAgICAgdGhpcy5fcGFnaW5hdG9yLnBhZ2Uuc3Vic2NyaWJlKHRoaXMuX3BhZ2luYXRvclBhcmFtcykgOlxuICAgICAgICBTdWJzY3JpcHRpb24uRU1QVFk7XG4gIH1cbn1cbiJdfQ==