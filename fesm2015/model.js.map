{"version":3,"file":"model.js","sources":["../../../../../../src/material/model/model-data-source.ts","../../../../../../src/material/model/model-data-source-filters.ts","../../../../../../src/material/model/public-api.ts","../../../../../../src/material/model/index.ts"],"sourcesContent":["/**\n * @license\n * Copyright (C) Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {CollectionViewer, DataSource} from '@angular/cdk/collections';\nimport {EventEmitter} from '@angular/core';\nimport {MatPaginator, PageEvent} from '@angular/material/paginator';\nimport {MatSort, Sort} from '@angular/material/sort';\nimport {\n  mergeQueryParams,\n  Model,\n  ModelListParams,\n  ModelListResult,\n  ModelQueryParams,\n} from '@gngt/core/common';\nimport {ModelActionTypes, ModelService, State as ModelState} from '@gngt/core/model';\nimport {BehaviorSubject, combineLatest, Observable, of as obsOf, Subscription} from 'rxjs';\nimport {debounceTime, map, startWith, switchMap, tap} from 'rxjs/operators';\n\nimport {ModelDataSourceFilters} from './model-data-source-filters';\n\ntype DataStreamType = [\n  PageEvent | null, Sort | null, string, string[], ModelDataSourceFilters, void,\n  Partial<ModelQueryParams>| null\n];\n\nexport class ModelDataSource<T extends Model, S extends ModelState<T> = ModelState<T>, A extends\n                                 ModelActionTypes = ModelActionTypes,\n                                 MS extends ModelService<T, S, A> = ModelService<T, S, A>> extends\n    DataSource<T> {\n  constructor(private _service: MS, private _baseParams: ModelListParams = {}) {\n    super();\n  }\n\n  get sort(): MatSort|null {\n    return this._sort;\n  }\n  set sort(sort: MatSort|null) {\n    this._sort = sort;\n    this._updateSort();\n  }\n  private _sort: MatSort|null = null;\n\n  get filter(): string {\n    return this._filter.value;\n  }\n  set filter(filter: string) {\n    this._filter.next(filter);\n  }\n  private _filter: BehaviorSubject<string> = new BehaviorSubject<string>('');\n\n  get baseQueryParams(): Partial<ModelQueryParams>|null {\n    return this._baseQueryParams.value;\n  }\n  set baseQueryParams(params: Partial<ModelQueryParams|null>) {\n    this._baseQueryParams.next(params);\n  }\n  private _baseQueryParams = new BehaviorSubject<Partial<ModelQueryParams>|null>(null);\n\n  private _freeTextSearchFields: BehaviorSubject<string[]> = new BehaviorSubject<string[]>([]);\n  get freeTextSearchFields(): string[] {\n    return this._freeTextSearchFields.value;\n  }\n  set freeTextSearchFields(freeTextSearchFields: string[]) {\n    this._freeTextSearchFields.next([...freeTextSearchFields]);\n  }\n\n  get filters(): ModelDataSourceFilters {\n    return this._filters.value;\n  }\n  set filters(filters: ModelDataSourceFilters) {\n    this._filters.next(filters);\n  }\n  private _filters: BehaviorSubject<ModelDataSourceFilters> =\n      new BehaviorSubject<ModelDataSourceFilters>({});\n\n  get paginator(): MatPaginator|null {\n    return this._paginator;\n  }\n  set paginator(paginator: MatPaginator|null) {\n    this._paginator = paginator;\n    this._updatePaginator();\n  }\n  private _paginator: MatPaginator|null = null;\n\n  private _data: BehaviorSubject<T[]> = new BehaviorSubject<T[]>([]);\n  get data(): T[] {\n    return this._data.value;\n  }\n\n  private _dataModifier: (data: T[]) => Observable<T[]>;\n  set dataModifier(dataModifier: (data: T[]) => Observable<T[]>) {\n    this._dataModifier = dataModifier;\n  }\n\n  private _sortParams: BehaviorSubject<Sort|null> = new BehaviorSubject<Sort|null>(null);\n  private _sortSubscription: Subscription = Subscription.EMPTY;\n  private _paginatorParams: BehaviorSubject<PageEvent|null> =\n      new BehaviorSubject<PageEvent|null>(null);\n  private _paginatorSubscription: Subscription = Subscription.EMPTY;\n  private _dataSubscription: Subscription = Subscription.EMPTY;\n  private _refreshEvent: EventEmitter<void> = new EventEmitter<void>();\n\n  connect(_: CollectionViewer): Observable<T[]> {\n    this._initData();\n    return this._data as Observable<T[]>;\n  }\n\n  disconnect(_: CollectionViewer): void {\n    this._dataSubscription.unsubscribe();\n    this._sortSubscription.unsubscribe();\n    this._paginatorSubscription.unsubscribe();\n    this._sortParams.complete();\n    this._paginatorParams.complete();\n    this._filters.complete();\n  }\n\n  refresh(): void {\n    this._refreshEvent.next();\n  }\n\n  private _initData(): void {\n    const baseStream = combineLatest<DataStreamType>(\n        this._paginatorParams, this._sortParams, this._filter, this._freeTextSearchFields,\n        this._filters, this._refreshEvent, this._baseQueryParams);\n    const startValue = [null, null, '', [], {}, undefined, null] as DataStreamType;\n    this._dataSubscription =\n        baseStream\n            .pipe(\n                startWith(startValue),\n                debounceTime(10),\n                switchMap(p => {\n                  const pagination = p[0];\n                  const sort = p[1];\n                  const filter = p[2];\n                  const freeTextSearchFields = p[3];\n                  const filters = p[4];\n                  const freeTextSel: {[key: string]: any} = {};\n                  const filterWord = (filter || '').trim();\n                  const baseParams = p[6];\n                  if (filter != null && freeTextSearchFields != null && filterWord.length > 0 &&\n                      freeTextSearchFields.length > 0) {\n                    freeTextSel['$or'] = freeTextSearchFields.map(key => {\n                      const keySel: {[key: string]: {'$regex': string}} = {};\n                      keySel[key] = {'$regex': filterWord};\n                      return keySel;\n                    });\n                  }\n                  const params: ModelQueryParams = {\n                    ...this._baseParams,\n                    selector: {\n                      ...filters,\n                      ...freeTextSel,\n                    }\n                  };\n                  if (pagination != null) {\n                    const pag = pagination as PageEvent;\n                    params.limit = pag.pageSize;\n                    params.start = pag.pageIndex * pag.pageSize;\n                  }\n                  if (sort != null) {\n                    const so = sort as Sort;\n                    const direction: 'asc'|'desc' = so.direction === '' ? 'asc' : so.direction;\n                    params.sort = {[so.active]: direction};\n                  }\n                  return this._service.query(mergeQueryParams(params, baseParams || {}));\n                }),\n                tap(o => {\n                  const list = o as ModelListResult<T>;\n                  const paginator = this.paginator;\n                  if (paginator != null) {\n                    paginator.length = list && list.count ? list.count : 0;\n                  }\n                }),\n                map(o => {\n                  const list = o as ModelListResult<T>;\n                  return list && list.results ? list.results : [];\n                }),\n                switchMap(data => {\n                  if (this._dataModifier != null) {\n                    return this._dataModifier(data);\n                  }\n                  return obsOf(data);\n                }),\n                )\n            .subscribe(data => {\n              this._data.next(data as T[]);\n            });\n\n    this._refreshEvent.next();\n  }\n\n  private _updateSort(): void {\n    this._sortSubscription.unsubscribe();\n    this._sortSubscription =\n        this._sort != null ? this._sort.sortChange.subscribe(this._sortParams) : Subscription.EMPTY;\n  }\n\n  private _updatePaginator(): void {\n    this._paginatorSubscription.unsubscribe();\n    this._paginatorSubscription = this._paginator != null ?\n        this._paginator.page.subscribe(this._paginatorParams) :\n        Subscription.EMPTY;\n  }\n}\n","/**\n * @license\n * Copyright (C) Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nexport type ModelDataSourceFilters = {\n  [key: string]: any\n};\n","/**\n * @license\n * Copyright (C) Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nexport * from './model-data-source';\nexport * from './model-data-source-filters';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["obsOf"],"mappings":"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"}